#!/usr/bin/env node

/**
 * Build-time script that reads all markdown blog posts from content/blog/,
 * parses frontmatter with gray-matter and renders HTML with remark,
 * then generates a static TypeScript file that can be imported at runtime
 * (no fs needed — works on Cloudflare Workers).
 *
 * Usage: node scripts/generate-blog-data.mjs
 */

import fs from "fs";
import path from "path";
import matter from "gray-matter";
import { remark } from "remark";
import remarkHtml from "remark-html";

const CONTENT_DIR = path.join(process.cwd(), "content", "blog");
const OUTPUT_FILE = path.join(process.cwd(), "src", "lib", "blog-md-data.ts");

async function main() {
  if (!fs.existsSync(CONTENT_DIR)) {
    console.log("[blog] No content/blog directory found — generating empty file.");
    fs.writeFileSync(
      OUTPUT_FILE,
      `// Auto-generated by scripts/generate-blog-data.mjs — DO NOT EDIT\nimport type { BlogPost } from "./blog";\nexport const mdPosts: BlogPost[] = [];\n`
    );
    return;
  }

  const files = fs.readdirSync(CONTENT_DIR).filter((f) => f.endsWith(".md"));
  console.log(`[blog] Found ${files.length} markdown posts`);

  const posts = [];

  for (const file of files) {
    const raw = fs.readFileSync(path.join(CONTENT_DIR, file), "utf-8");
    const { data, content } = matter(raw);

    const result = await remark().use(remarkHtml, { sanitize: false }).process(content);

    posts.push({
      slug: file.replace(/\.md$/, ""),
      title: data.title || "",
      description: data.description || "",
      date: data.date || "",
      author: data.author || "FormGuard Team",
      category: data.category || "General",
      readTime: data.readTime || "5 min read",
      featured: data.featured || false,
      content: result.toString(),
    });
  }

  // Sort by date descending
  posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

  // Generate TS file
  const output = `// Auto-generated by scripts/generate-blog-data.mjs — DO NOT EDIT
// Last generated: ${new Date().toISOString()}
import type { BlogPost } from "./blog";

export const mdPosts: BlogPost[] = ${JSON.stringify(posts, null, 2)};
`;

  fs.writeFileSync(OUTPUT_FILE, output);
  console.log(`[blog] Generated ${OUTPUT_FILE} with ${posts.length} posts`);
}

main().catch(console.error);
